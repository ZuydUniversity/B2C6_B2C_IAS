- name: Setup OpenSCAP and Schedule Daily Scans
  hosts: all
  become: yes
  vars_files:
    - vars/main.yml
  tasks:
    - name: Install required packages
      apt:
        name:
          - cmake
          - make
          - expat 
          - libopenscap8 
          - libxml2-utils 
          - ninja-build 
          - python3-jinja2 
          - python3-yaml 
          - python3-setuptools 
          - xsltproc
          - azure-cli 
        state: present
        update-cache: yes

    - name: Install OpenSCAP
      shell:
        cmd: |
          git clone -b master https://github.com/ComplianceAsCode/content.git
          cd content/build/
          cmake ../
          make -j4

          ls -lah ssg-ubuntu2204*
          oscap info ssg-ubuntu2204-ds-1.2.xml
          oscap info --profile xccdf_org.ssgproject.content_profile_cis_level2_server ssg-ubuntu2204-ds-1.2.xml

    - name: Perform one-time OpenSCAP scan
      shell:
        cmd: |
          timestamp=$(date +%Y%m%d%H%M%S)
          report_name="openscap_report_$timestamp.html"
          oscap xccdf eval --profile xccdf_org.ssgproject.content_profile_ospp --results /tmp/openscap_results.xml --report /tmp/$report_name /usr/share/xml/scap/ssg/content/ssg-ubuntu2204-ds.xml
          blob_exists=$(az storage blob exists --account-name "{{ storage_account_name }}" --container-name "{{ blob_container_name }}" --name $report_name --output tsv)
          if [ "$blob_exists" != "True" ]; then
            az storage blob upload --account-name "{{ storage_account_name }}" --container-name "{{ blob_container_name }}" --name $report_name --file /tmp/$report_name
          fi
        creates: /usr/local/bin/openscap_scan_done


    - name: Create OpenSCAP scan script
      copy:
        dest: /usr/local/bin/openscap_scan.sh
        content: | 
          #!/bin/bash
          timestamp=$(date +%Y%m%d%H%M%S)
          report_name="openscap_report_$timestamp.html"
          oscap xccdf eval --profile xccdf_org.ssgproject.content_profile_ospp --results /tmp/openscap_results.xml --report /tmp/$report_name /usr/share/xml/scap/ssg/content/ssg-ubuntu2204-ds.xml
          az storage blob upload --account-name {{ storage_account_name }} --container-name {{ blob_container_name }} --name $report_name --file /tmp/$report_name

    - name: Make script executable
      file:
        path: /usr/local/bin/openscap_scan.sh
        state: file
        mode: '0755'

    - name: Schedule daily OpenSCAP scan
      cron:
        name: "Daily OpenSCAP scan"
        minute: "0"
        hour: "0"
        job: /usr/local/bin/openscap_scan.sh
