- name: Setup OpenSCAP and Schedule Daily Scans
  hosts: all
  become: yes
  vars_files:
    - vars/main.yml
  tasks:
    - name: Install required packages
      apt:
        name:
          - libopenscap8 
          - curl 
          - zip 
          - git
        state: present
        update-cache: yes

    - name: Setup azure cli
      shell: |
        sudo apt remove azure-cli -y && sudo apt autoremove -y
        curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash

    - name: Create directory for SCAP content
      file:
        path: /usr/share/xml/scap/ssg/content/
        state: directory
        mode: '0755'

    - name: Install OpenSCAP
      shell: |
        SSG_VERSION=$(git ls-remote --tags --ref --sort v:refname https://github.com/ComplianceAsCode/content.git | grep -Pio '(\d+(\.)){2}[\w\.-][\d+]' | tail -1)
        sudo wget https://github.com/ComplianceAsCode/content/releases/download/v${SSG_VERSION}/scap-security-guide-${SSG_VERSION}.zip -O /usr/share/xml/scap/ssg/content/ssg.zip
        sudo unzip -jo /usr/share/xml/scap/ssg/content/ssg.zip "scap-security-guide-${SSG_VERSION}/*" -d /usr/share/xml/scap/ssg/content/

    - name: Perform one-time OpenSCAP scan
      shell: |
        timestamp=$(date +%Y%m%d%H%M%S)
        report_name="openscap_report_$timestamp.html"
        oscap xccdf eval --profile xccdf_org.ssgproject.content_profile_ospp --results /tmp/openscap_results.xml --report /tmp/$report_name /usr/share/xml/scap/ssg/content/ssg-ubuntu2204-ds.xml
        blob_exists=$(az storage blob exists --account-name "{{ storage_account_name }}" --container-name "{{ blob_container_name }}" --name $report_name --output tsv)
        if [ "$blob_exists" != "True" ]; then
          az storage blob upload --account-name "{{ storage_account_name }}" --container-name "{{ blob_container_name }}" --name $report_name --file /tmp/$report_name
        fi
      creates: /usr/local/bin/openscap_scan_done

    - name: Create OpenSCAP scan script
      copy:
        dest: /usr/local/bin/openscap_scan.sh
        content: | 
          #!/bin/bash
          timestamp=$(date +%Y%m%d%H%M%S)
          report_name="openscap_report_$timestamp.html"
          oscap xccdf eval --profile xccdf_org.ssgproject.content_profile_ospp --results /tmp/openscap_results.xml --report /tmp/$report_name /usr/share/xml/scap/ssg/content/ssg-ubuntu2204-ds.xml
          az storage blob upload --account-name {{ storage_account_name }} --container-name {{ blob_container_name }} --name $report_name --file /tmp/$report_name

    - name: Make script executable
      file:
        path: /usr/local/bin/openscap_scan.sh
        state: file
        mode: '0755'

    - name: Schedule daily OpenSCAP scan
      cron:
        name: "Daily OpenSCAP scan"
        minute: "0"
        hour: "0"
        job: /usr/local/bin/openscap_scan.sh
